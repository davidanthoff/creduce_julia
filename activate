# script to prepare the environment to load packages from the creduce depot

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

DEPOT="$DIR/depot"

export JULIA_DEPOT_PATH=$DEPOT

if [[ "$(pwd)" == "$DIR" ]]; then
    # in-tree execution, not by creduce
    export JULIA_PKG_DEVDIR=$DEPOT/dev
else
    # out-of-tree execution, by creduce

    # start with the initial devdir (there may be non-source files we need)
    mkdir -p depot
    cp -arf $DEPOT/dev depot
    export JULIA_PKG_DEVDIR="$(pwd)/depot/dev"

    # copy-in the files created by creduce
    i=1
    while IFS= read -r path; do
        mkdir -p $(dirname $path)
        cp "$i.jl" "$path"
        (( i++ ))
    done < "$DIR/src.lst"

    # use a layered depot so that we don't contaminate the global one
    export JULIA_DEPOT_PATH="$(pwd)/depot:$JULIA_DEPOT_PATH"
    # HACK: juliaup doesn't support layered depots (JuliaLang/juliaup#323)
    if [[ -d "$DEPOT/juliaup" ]]; then
        ln -s "$DEPOT/juliaup" "$(pwd)/depot/juliaup"
    fi
fi
